# Linux Malwares

## ELF headers manipulation

Attacker will tamper with the ELF headers as an anti-analysis. There are two types of modifications:

### Anomalous ELF

Files which follow the ELF specification but usually won't be generated by traditional compilers. 

Examples:

- Removing all information about the ELF sections - sections information are not used at runtime, therefore the file could be executed.
- False information - filling fields with false information such as, different operation system at system API field.

### Invalid ELF

Files that contains invalid data but still could run on the system. Usually achieved by supply invalid data into `e_shoff`, `e_shnum`, `e_shentsize`, etc.

Examples:
- Section header table pointing beyond file data
- Wrong string table index (`e_ehstrndx`) 
- Overlapping ELF header/segment
- Invalid pointers - segment header table pointing beyond file data

*ELF Parsers:*

- readelf 
- pyelftools
- GDB
- IDA Pro

## Deception

Malwares trying to be less noticeable often change their name to be one of the common system process such as, `sshd`, `telnetd`, `cron`, etc. In many cases, malwares use empty name.

Changing the process name could be done by:

- Calling `prctl` system call with `PR_SET_NAME` - results different process name listed in `/proc/<PID>/status`.
- Modifying the first command-line argument (which represents the process name) - `/proc/<PID>/cmdline`.

## Privilege Escalation

Malware need privileges for proper execution. `root` privileges allow malware preform the following actions:

- Execute privileged shell command
- Drop a file into a protected directory
- Achieve system-wide persistence
- Tamper with Sandbox
- Delete a protected file
- Run `ptrace` request on another process
- Load new kernel modules

Gaining escalated privileges usually done by exploiting a vulnerability and root default passwords.

## Persistence

Malwares could use the following techniques for achieving persistence on infected system.

### Subsystem Initialization

According to [Wikipedia](https://en.wikipedia.org/wiki/Init): 

> In Unix-based computer operating systems, init (short for initialization) is the first process started during booting of the computer system. Init is a daemon process that continues running until the system is shut down.

Manipulating one of the following paths should result with malware persistence:

- `/etc/rc.d/rc.local`
- `/etc/rc.conf`
- `/etc/init.d/`
- `/etc/rcX.d/`
- `/etc/rc.local`
- `systemd` service
- `~/.bashrc`
- `~/.bash_profile`
- *X* desktop autostart

*Most of the listed locations required root privileges for modification.*

### Time-based Execution

Linux equivalent to Windows's Task Scheduler. Malwares with the right privileges will be able to register a `cron` job which will execute the malware according to the job configuration.

Related paths:

- `/etc/cron.hourly/`
- `/etc/crontab`
- `/etc/cron.daily/`

### File Infection and Replacement

